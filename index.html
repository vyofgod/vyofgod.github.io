<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XSearchEngine</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link id="main-font" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <style>
        :root {
            --bg-color: #000000;
            --text-color: #ffffff;
            --widget-bg: rgba(255, 255, 255, 0.05);
            --border-color: rgba(255, 255, 255, 0.1);
            --accent-color: #3b82f6;
            --accent-text-color: #ffffff; /* Yeni Değişken */
            --text-muted: #a0a0a0;
            --font-family: 'Inter', sans-serif;
            --panel-section-bg: rgba(255, 255, 255, 0.05);
            --hover-bg: rgba(255, 255, 255, 0.1);
            --border-radius: 1rem;
            --shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        [data-theme="light"] { --bg-color: #f0f2f5; --text-color: #111827; --widget-bg: #ffffff; --border-color: #e5e7eb; --text-muted: #6b7280; --panel-section-bg: #f9fafb; --hover-bg: rgba(0, 0, 0, 0.05); }
        [data-theme="dark"] { --bg-color: #121212; --text-color: #e0e0e0; --widget-bg: #1f2937; --border-color: #374151; --text-muted: #9ca3af; --panel-section-bg: rgba(255, 255, 255, 0.05); --hover-bg: rgba(255, 255, 255, 0.1); --shadow: 0 4px 20px rgba(0,0,0,0.2); }
        [data-theme="retro"] { --bg-color: #000000; --text-color: #00ff41; --widget-bg: #0d0d0d; --border-color: #00ff41; --accent-color: #00ff41; --text-muted: #00a72a; --panel-section-bg: #1a1a1a; --hover-bg: #1a1a1a; --font-family: 'VT323', monospace; --border-radius: 0; --shadow: none; }
        [data-theme="serene"] { --bg-color: #e8f5e9; --text-color: #37474f; --widget-bg: rgba(255, 255, 255, 0.7); --border-color: rgba(100, 181, 246, 0.3); --accent-color: #29b6f6; --text-muted: #78909c; --panel-section-bg: rgba(255, 255, 255, 0.9); --hover-bg: rgba(179, 229, 252, 0.4); --font-family: 'Lora', serif; --border-radius: 1.5rem; --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1); }
        [data-theme="neon"] { --bg-color: #0a0a1a; --text-color: #e0e0ff; --widget-bg: rgba(20, 20, 40, 0.6); --border-color: rgba(255, 0, 255, 0.5); --accent-color: #ff00ff; --text-muted: #8a8ac7; --panel-section-bg: rgba(20, 20, 40, 0.8); --hover-bg: rgba(255, 0, 255, 0.1); --font-family: 'Orbitron', sans-serif; --border-radius: 0.75rem; --shadow: 0 0 15px rgba(255, 0, 255, 0.3), 0 0 5px rgba(255, 0, 255, 0.2); }
        [data-theme="paper"] { --bg-color: #fdfaf4; --text-color: #4c4a44; --widget-bg: #ffffff; --border-color: #e7e5e0; --accent-color: #d9534f; --text-muted: #96938c; --panel-section-bg: #f9f6f0; --hover-bg: #f5f2e9; --font-family: 'Merriweather', serif; --border-radius: 0.25rem; --shadow: 0 2px 4px rgba(0,0,0,0.05); }

        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

        body { font-family: var(--font-family); background-color: var(--bg-color); color: var(--text-color); transition: background-color 0.5s ease, color 0.5s ease, background-image 0.5s ease; background-size: cover; background-position: center; background-attachment: fixed; display: flex; flex-direction: column; height: 100vh; }
        body:not(.no-animations) .animated { animation: fadeInUp 0.5s ease-out forwards; }
        body::before { content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-image: radial-gradient(circle at 10% 10%, var(--accent-color), transparent 40vmax); opacity: 0.15; z-index: -1; transition: background-image 0.5s ease, opacity 0.5s ease; }

        .widget, .modal-content, #settings-panel, .search-input { border-radius: var(--border-radius); }
        .widget { background-color: var(--widget-bg); border: 1px solid var(--border-color); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); box-shadow: var(--shadow); transition: all 0.3s ease; opacity: 0; color: var(--text-color); }
        #weather-widget:hover { cursor: pointer; }
        .accent-text { color: var(--accent-color); }
        .accent-bg { background-color: var(--accent-color); color: var(--accent-text-color); }

        #settings-panel { transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); transform: translateX(100%); background-color: var(--widget-bg); backdrop-filter: blur(12px); border-left: 1px solid var(--border-color); }
        #settings-panel.open { transform: translateX(0); }

        .sortable-ghost { opacity: 0.8 !important; background: var(--accent-color) !important; border: 2px dashed var(--text-color); }
        .sortable-ghost, .sortable-ghost .widget { border-radius: var(--border-radius); }
        .sortable-drag { opacity: 0.9; transform: scale(1.02); box-shadow: 0 16px 32px rgba(0,0,0,0.3) !important; }

        input, textarea, select, button { border-radius: var(--border-radius); }
        input:focus, textarea:focus, select:focus { outline: none; }
        .input-base { background-color: transparent; border: 1px solid var(--border-color); color: var(--text-color); transition: box-shadow 0.2s ease, border-color 0.2s ease; }
        .input-base:focus { border-color: var(--accent-color); box-shadow: 0 0 0 1px var(--accent-color); }
        .input-base::placeholder { color: var(--text-muted); }

        .search-input { background-color: var(--widget-bg); border: 2px solid var(--border-color); color: var(--text-color); transition: all 0.2s ease-in-out; }
        .search-input:focus { border-color: var(--accent-color); box-shadow: 0 0 0 2px var(--accent-color); }
        .themed-hover:hover { background-color: var(--hover-bg); }
        .panel-section { background-color: var(--panel-section-bg); border-radius: var(--border-radius); }
        .modal-content { color: var(--text-color); background-color: var(--widget-bg); }
        .modal-text { color: var(--text-muted); }

        .modal-backdrop { animation: fadeIn 0.3s ease; }
        .modal-backdrop.fade-out { animation: fadeOut 0.3s ease forwards; }

        .tab-button { padding: 0.5rem 1rem; border-radius: 9999px; transition: all 0.2s ease-in-out; border: 2px solid transparent; color: var(--text-muted); }
        .tab-button:hover:not(.active) { background-color: var(--hover-bg); }
        .tab-button.active { background-color: var(--accent-color); color: var(--accent-text-color); font-weight: 600; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.4s; }

        #command-palette { background-color: rgba(0,0,0,0.5); backdrop-filter: blur(8px); }
        #command-palette-modal { background-color: var(--widget-bg); border: 1px solid var(--border-color); box-shadow: var(--shadow); }
        .command-item.selected { background-color: var(--accent-color); color: var(--accent-text-color); }
        .command-item.selected .command-desc { color: var(--accent-text-color); opacity: 0.8; }

        .code-editor { font-family: 'Courier New', Courier, monospace; font-size: 14px; background-color: var(--panel-section-bg); border: 1px solid var(--border-color); color: var(--text-color); }

        #accent-color-wrapper { position: relative; width: 100%; height: 2.5rem; }
        #accent-color-display { width: 100%; height: 100%; border: 1px solid var(--border-color); border-radius: var(--border-radius); cursor: pointer; transition: border-color 0.2s ease; }
        #accent-color-display:hover { border-color: var(--accent-color); }
        #accent-color-input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }

        @media (max-width: 768px) {
            #widget-grid { grid-template-columns: repeat(1, 1fr) !important; }
            #settings-panel, #custom-widget-modal { max-width: 100vw; }
            #clock { font-size: 3.75rem; }
            #settings-tabs { flex-wrap: wrap; justify-content: center; }
        }
    </style>
</head>
<body class="overflow-hidden">

    <header class="flex-shrink-0 flex flex-col items-center justify-center pt-12 md:pt-16 pb-8 px-4 text-center">
        <div id="clock" class="text-6xl md:text-7xl font-bold mb-6 animated"></div>
        <form action="https://www.google.com/search" method="get" target="_blank" class="w-full max-w-xl mx-auto animated" style="animation-delay: 100ms;">
             <div class="relative">
                <i data-lucide="search" class="absolute left-5 top-1/2 -translate-y-1/2 w-6 h-6" style="color: var(--text-muted);"></i>
                <input type="text" name="q" placeholder="Google'da Ara veya bir adres yaz" autocomplete="off" class="search-input w-full py-4 pl-14 pr-6 text-lg">
            </div>
        </form>
    </header>

    <main id="widget-grid" class="flex-grow p-4 md:p-6 grid gap-4 md:gap-5 overflow-y-auto" style="grid-auto-rows: minmax(150px, auto);"></main>

    <button id="settings-toggle" class="fixed bottom-6 right-6 p-3 rounded-full accent-bg shadow-lg hover:opacity-90 transition-all duration-300 transform hover:scale-110 active:scale-100">
        <i data-lucide="settings" class="w-6 h-6"></i>
    </button>

    <!-- Modallar -->
    <div id="command-palette" class="hidden fixed inset-0 z-50 flex justify-center pt-[20vh]">
        <div id="command-palette-modal" class="w-full max-w-2xl rounded-lg overflow-hidden">
            <input type="text" id="command-input" class="w-full p-4 text-lg bg-transparent border-b" style="border-color: var(--border-color);" placeholder="Komut ara...">
            <ul id="command-list" class="max-h-80 overflow-y-auto"></ul>
        </div>
    </div>

    <div id="custom-widget-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-md z-50 p-4 flex items-center justify-center modal-backdrop">
        <div class="modal-content w-full max-w-6xl h-[90vh] p-4 flex flex-col">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h3 class="text-xl font-bold">Özel Widget Oluşturucu</h3>
                <button id="custom-widget-close" class="p-2 themed-hover rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="flex-grow grid grid-cols-1 md:grid-cols-2 gap-4 h-full">
                <div class="flex flex-col gap-4">
                    <div><label class="block text-sm mb-1">HTML</label><textarea id="widget-html" class="code-editor w-full h-32"></textarea></div>
                    <div><label class="block text-sm mb-1">CSS</label><textarea id="widget-css" class="code-editor w-full h-32"></textarea></div>
                    <div><label class="block text-sm mb-1">JavaScript</label><textarea id="widget-js" class="code-editor w-full h-32"></textarea></div>
                </div>
                <div class="flex flex-col">
                    <label class="block text-sm mb-1">Önizleme</label>
                    <iframe id="widget-preview" class="w-full h-full border" style="border-color: var(--border-color);" sandbox="allow-scripts"></iframe>
                </div>
            </div>
            <div class="mt-4 flex justify-end space-x-3 flex-shrink-0">
                <button id="widget-preview-btn" class="px-4 py-2 bg-blue-600/80 hover:bg-blue-600 text-white">Önizle</button>
                <button id="widget-save-btn" class="px-4 py-2 accent-bg">Kaydet</button>
            </div>
        </div>
    </div>

    <div id="weather-details-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-md flex items-center justify-center z-50 p-4 modal-backdrop"> <div class="modal-content p-6 shadow-xl max-w-2xl w-full text-center"> <div class="flex justify-between items-center mb-4"> <h3 id="weather-modal-title" class="text-xl font-bold">5 Günlük Hava Tahmini</h3> <button id="weather-modal-close" class="p-2 themed-hover rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button> </div> <div id="weather-modal-content" class="grid grid-cols-2 md:grid-cols-5 gap-4 text-center"></div></div></div>
    <div id="alert-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 modal-backdrop"> <div class="modal-content p-6 shadow-xl max-w-sm text-center"> <h3 id="alert-title" class="text-lg font-bold mb-4"></h3> <p id="alert-text" class="text-sm text-muted mb-6"></p> <button id="alert-ok" class="px-5 py-2 accent-bg">Tamam</button> </div> </div>
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 modal-backdrop"> <div class="modal-content p-6 shadow-xl max-w-sm text-center"> <h3 id="modal-title" class="text-lg font-bold mb-4">Emin misiniz?</h3> <p id="modal-text" class="modal-text text-sm mb-6">Bu işlem geri alınamaz.</p> <div class="flex justify-end space-x-3"> <button id="modal-cancel" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white">İptal</button> <button id="modal-confirm" class="px-4 py-2 bg-red-600 hover:bg-red-500 text-white">Onayla</button> </div> </div> </div>

    <!-- Ayarlar Paneli -->
    <div id="settings-panel" class="fixed top-0 right-0 h-full w-full md:max-w-sm p-6 overflow-y-auto z-40">
        <div class="flex justify-between items-center mb-6"> <h2 class="text-2xl font-bold">Ayarlar</h2> <button id="settings-close" class="p-2 themed-hover rounded-full"><i data-lucide="x" class="w-6 h-6"></i></button> </div>
        <div class="border-b" style="border-color: var(--border-color);">
            <nav class="flex space-x-2" id="settings-tabs">
                <button data-tab="appearance" class="tab-button text-sm font-medium">Görünüm</button>
                <button data-tab="layout" class="tab-button text-sm font-medium">Düzen</button>
                <button data-tab="widgets" class="tab-button text-sm font-medium">Widget'lar</button>
                <button data-tab="developer" class="tab-button text-sm font-medium">Geliştirici</button>
            </nav>
        </div>
        <div class="py-6">
            <div id="tab-appearance" class="tab-content space-y-6">
                <div class="space-y-4 p-4 panel-section">
                    <div>
                        <label class="block text-sm font-medium">Tema</label>
                        <select id="theme-select" class="input-base w-full mt-1 p-2"> <option value="dark">Koyu</option> <option value="light">Açık</option> <option value="black">Gece</option> <option value="retro">Retro Terminal</option> <option value="serene">Huzurlu Doğa</option> <option value="neon">Neon Gecesi</option> <option value="paper">Minimalist Kağıt</option> </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Vurgu Rengi</label>
                        <div id="accent-color-wrapper" class="mt-1">
                            <div id="accent-color-display"></div>
                            <input type="color" id="accent-color-input">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Arkaplan URL</label> <input type="text" id="bg-image-url" placeholder="https://..." class="input-base w-full mt-1 p-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Yazı Tipi</label> <select id="font-select" class="input-base w-full mt-1 p-2"> <option>Inter</option> <option>Roboto</option> <option>Poppins</option> <option>VT323</option> <option>Lora</option> <option>Orbitron</option> <option>Merriweather</option> </select>
                    </div>
                    <div class="flex items-center justify-between">
                        <label class="text-sm font-medium">Animasyonlar</label> <button id="animation-toggle" class="relative inline-flex items-center h-6 rounded-full w-11"></button>
                    </div>
                </div>
                <div class="p-4 panel-section"> <h3 class="font-bold mb-3 text-lg">Bağlantılarım</h3> <div id="link-list" class="space-y-2 mb-4 max-h-40 overflow-y-auto"></div><div class="flex space-x-2"><input type="text" id="link-name-input" placeholder="İsim" class="input-base w-1/2 p-2"><input type="text" id="link-url-input" placeholder="URL" class="input-base w-1/2 p-2"></div><button id="add-link-btn" class="w-full mt-3 p-2 accent-bg font-bold">Ekle</button></div>
                <div class="space-y-2 p-4 panel-section"> <h3 class="font-bold mb-3 text-lg">Veri Yönetimi</h3> <button id="export-settings-btn" class="w-full p-2 bg-blue-600/50 hover:bg-blue-600/70 text-white">Dışa Aktar</button> <button id="import-settings-btn" class="w-full p-2 mt-2 bg-green-600/50 hover:bg-green-600/70 text-white">İçe Aktar</button> <input type="file" id="import-file-input" class="hidden" accept=".json"> <button id="reset-settings-btn" class="w-full p-2 mt-2 bg-red-600/50 hover:bg-red-600/70 text-white">Sıfırla</button> </div>
            </div>
            <div id="tab-layout" class="tab-content space-y-4"> <div class="space-y-4 p-4 panel-section"> <div><label class="block text-sm font-medium">Sütun Sayısı: <span id="column-count-label"></span></label><input type="range" id="column-count" min="1" max="5" step="1" class="w-full mt-1"></div><div><label class="block text-sm font-medium">Widget Aralığı: <span id="gap-size-label"></span>px</label><input type="range"id="gap-size" min="8" max="40" step="4" class="w-full mt-1"></div></div> </div>
            <div id="tab-widgets" class="tab-content space-y-3"> <div id="widget-toggle-list" class="space-y-3 p-4 panel-section"></div> </div>
            <div id="tab-developer" class="tab-content space-y-3">
                <div class="p-4 panel-section">
                    <h3 class="font-bold mb-3 text-lg">Özel Widget'lar</h3>
                    <div id="custom-widget-list" class="space-y-2 mb-4"></div>
                    <button id="add-custom-widget-btn" class="w-full p-2 accent-bg font-bold">Yeni Widget Oluştur</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Widget Şablonları -->
    <template id="widget-day-progress-template"><div class="widget animated p-4 md:p-6" data-widget-id="day_progress"><h4 class="font-bold mb-3">Günün İlerlemesi</h4><div class="w-full h-2 rounded-full" style="background-color: var(--border-color);"><div id="day-progress" class="accent-bg h-2 rounded-full"></div></div><div id="day-progress-text" class="text-right text-sm mt-2" style="color: var(--text-muted)"></div></div></template>
    <template id="widget-weather-template"><div id="weather-widget" class="widget animated p-4 md:p-6" data-widget-id="weather"><h4 class="font-bold mb-4">Hava Durumu</h4> <div id="weather-content">Yükleniyor...</div></div></template>
    <template id="widget-links-template"><div class="widget animated p-4 md:p-6" data-widget-id="links"><h4 class="font-bold mb-4">Hızlı Bağlantılar</h4><ul id="quick-links-list" class="space-y-3 text-lg"></ul></div></template>
    <template id="widget-tech-links-template"><div class="widget animated p-4 md:p-6" data-widget-id="tech_links"><h4 class="font-bold mb-4">Teknoloji & Geliştirme</h4><ul id="tech-links-list" class="space-y-3 text-lg"><li><a href="https://github.com" target="_blank" class="flex items-center space-x-2 hover:accent-text transition-colors"><i data-lucide="github" class="w-4 h-4"></i><span>GitHub</span></a></li><li><a href="https://stackoverflow.com" target="_blank" class="flex items-center space-x-2 hover:accent-text transition-colors"><i data-lucide="layers" class="w-4 h-4"></i><span>Stack Overflow</span></a></li><li><a href="https://dev.to" target="_blank" class="flex items-center space-x-2 hover:accent-text transition-colors"><i data-lucide="book-open" class="w-4 h-4"></i><span>Dev.to</span></a></li></ul></div></template>
    <template id="widget-todo-template"><div class="widget animated p-4 md:p-6 flex flex-col h-full min-h-[200px]" data-widget-id="todo"><div class="flex justify-between items-center mb-4"><h4 class="font-bold">Yapılacaklar</h4><select id="todo-category-filter" class="input-base text-sm p-1"><option value="all">Tümü</option><option value="work">İş</option><option value="personal">Kişisel</option></select></div><ul id="todo-list" class="space-y-2 overflow-y-auto flex-grow pr-2"></ul><div class="mt-4 flex space-x-2"><input type="text" id="todo-input" placeholder="Yeni görev..." class="input-base w-full p-2"><select id="todo-category-select" class="input-base p-2 text-sm"><option value="personal">Kişisel</option><option value="work">İş</option></select><button id="add-todo-btn" class="p-2 accent-bg"><i data-lucide="plus"></i></button></div></div></template>
    <template id="widget-notes-template"><div class="widget animated p-4 md:p-6 flex flex-col h-full min-h-[200px]" data-widget-id="notes"><h4 class="font-bold mb-2">Hızlı Notlar</h4><textarea id="notes-area" class="input-base w-full flex-grow resize-none p-2" style="background:transparent;" placeholder="Aklındakileri yaz..."></textarea></div></template>
    <template id="widget-quote-template"><div class="widget animated p-6 flex flex-col justify-center text-center" data-widget-id="quote"><div class="flex flex-col h-full justify-center text-center"><i data-lucide="quote" class="w-8 h-8 mx-auto mb-4" style="color: var(--text-muted);"></i><p id="quote-text" class="text-lg italic"></p><p id="quote-author" class="mt-4 font-bold text-sm" style="color: var(--text-muted);"></p></div></div></template>
    <template id="widget-trends-template"><div class="widget animated p-4 md:p-6" data-widget-id="trends"><h4 class="font-bold mb-4">Gündemdeki Aramalar</h4><ul id="trends-list" class="space-y-3"></ul></div></template>
    <template id="custom-widget-template"><div class="widget animated p-0 overflow-hidden" data-widget-id=""><iframe class="w-full h-full border-0"></iframe></div></template>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const THEME_PRESETS = {
            retro: { font: 'VT323', accent: '#00ff41', bg: '' },
            serene: { font: 'Lora', accent: '#29b6f6', bg: 'https://images.unsplash.com/photo-1444703686981-a3abbc4d4fe3?q=80&w=2070&auto=format&fit=crop' },
            neon: { font: 'Orbitron', accent: '#ff00ff', bg: 'https://images.unsplash.com/photo-1521791136064-7986c2920216?q=80&w=2070&auto=format&fit=crop' },
            paper: { font: 'Merriweather', accent: '#d9534f', bg: '' }
        };

        const DEFAULT_SETTINGS = {
            theme: 'dark', accentColor: '#3b82f6', backgroundImage: '', font: 'Inter',
            animations: true, columns: 4, gap: 20,
            widgets: ['weather', 'day_progress', 'links', 'tech_links', 'todo', 'notes', 'trends', 'quote'],
            links: [ { name: 'Gmail', url: 'https://mail.google.com' }, { name: 'YouTube', url: 'https://youtube.com' } ],
            todos: [], notes: '',
            widgetOrder: ['weather', 'day_progress', 'links', 'tech_links', 'todo', 'notes', 'trends', 'quote'],
            customWidgets: []
        };
        let settings = JSON.parse(localStorage.getItem('dashboardSettingsV7')) || JSON.parse(JSON.stringify(DEFAULT_SETTINGS));

        if (settings.todos.length > 0 && typeof settings.todos[0] === 'string') {
            settings.todos = settings.todos.map(task => ({ text: task, done: false, category: 'personal' }));
        }
        if (!settings.customWidgets) {
            settings.customWidgets = [];
        }

        function saveSettings() { localStorage.setItem('dashboardSettingsV7', JSON.stringify(settings)); }

        function getContrastingTextColor(hex) {
            if (!hex) return '#ffffff';
            const hexValue = hex.startsWith('#') ? hex.substring(1) : hex;
            const r = parseInt(hexValue.substr(0, 2), 16);
            const g = parseInt(hexValue.substr(2, 2), 16);
            const b = parseInt(hexValue.substr(4, 2), 16);
            const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
            return (yiq >= 128) ? '#111827' : '#ffffff';
        }

        const widgetGrid = document.getElementById('widget-grid');
        const settingsPanel = document.getElementById('settings-panel');
        const weatherDetailsModal = document.getElementById('weather-details-modal');
        const commandPalette = document.getElementById('command-palette');
        const commandInput = document.getElementById('command-input');
        const commandList = document.getElementById('command-list');
        const customWidgetModal = document.getElementById('custom-widget-modal');

        let ALL_WIDGETS = {};

        function buildWidgetList() {
            ALL_WIDGETS = {
                day_progress: { name: 'Günün İlerlemesi', template: 'widget-day-progress-template' },
                weather: { name: 'Hava Durumu', template: 'widget-weather-template' },
                links: { name: 'Hızlı Bağlantılar', template: 'widget-links-template' },
                tech_links: { name: 'Teknoloji Linkleri', template: 'widget-tech-links-template' },
                todo: { name: 'Yapılacaklar', template: 'widget-todo-template' },
                notes: { name: 'Notlar', template: 'widget-notes-template' },
                quote: { name: 'Günün Sözü', template: 'widget-quote-template' },
                trends: { name: 'Gündem', template: 'widget-trends-template' },
            };
            settings.customWidgets.forEach(widget => {
                ALL_WIDGETS[widget.id] = { name: widget.name, template: 'custom-widget-template', isCustom: true };
            });
        }

        function applySettings() {
            document.body.dataset.theme = settings.theme;
            const fontToApply = settings.font;
            const fontName = fontToApply.replace(' ', '+');
            const fontWeights = ':wght@400;500;700;900';
            document.getElementById('main-font').href = `https://fonts.googleapis.com/css2?family=${fontName}${fontWeights}&display=swap`;

            document.documentElement.style.setProperty('--font-family', `'${fontToApply}', sans-serif`);
            document.documentElement.style.setProperty('--accent-color', settings.accentColor);
            document.documentElement.style.setProperty('--accent-text-color', getContrastingTextColor(settings.accentColor));
            document.body.style.backgroundImage = settings.backgroundImage ? `url(${settings.backgroundImage})` : 'none';
            document.body.classList.toggle('no-animations', !settings.animations);

            const columns = window.innerWidth < 768 ? 1 : settings.columns;
            widgetGrid.style.gridTemplateColumns = `repeat(${columns}, minmax(0, 1fr))`;
            widgetGrid.style.gap = `${settings.gap}px`;

            buildWidgetList();
            updateSettingsPanelValues();
            renderWidgets();
        }

        function renderWidgets() {
            widgetGrid.innerHTML = '';
            let visibleWidgetCount = 0;
            const animationDelayBase = settings.animations ? 75 : 0;
            if(!settings.widgetOrder) settings.widgetOrder = Object.keys(ALL_WIDGETS);

            settings.widgetOrder.forEach(widgetId => {
                if (settings.widgets.includes(widgetId) && ALL_WIDGETS[widgetId]) {
                    const widgetInfo = ALL_WIDGETS[widgetId];
                    const template = document.getElementById(widgetInfo.template);
                    if(template) {
                        const clone = template.content.cloneNode(true);
                        const widgetElement = clone.querySelector('.widget') || clone.querySelector('[data-widget-id]');
                        widgetElement.dataset.widgetId = widgetId;

                        if (widgetInfo.isCustom) {
                            const customWidgetData = settings.customWidgets.find(w => w.id === widgetId);
                            const iframe = widgetElement.querySelector('iframe');
                            const iframeContent = `
                                <style>${customWidgetData.css}</style>
                                ${customWidgetData.html}
                                <script>${customWidgetData.js}<\/script>
                            `;
                            iframe.srcdoc = iframeContent;
                        }

                        if (widgetElement) { widgetElement.style.animationDelay = `${200 + (visibleWidgetCount * animationDelayBase)}ms`; }
                        widgetGrid.appendChild(clone);
                        visibleWidgetCount++;
                    }
                }
            });
            initWidgetFunctions();
        }

        function initWidgetFunctions() {
            updateTime();
            if (settings.widgets.includes('day_progress')) updateDayProgress();
            if (settings.widgets.includes('weather')) initWeatherWidget();
            if (settings.widgets.includes('links')) renderQuickLinks();
            if (settings.widgets.includes('todo')) initTodoWidget();
            if (settings.widgets.includes('notes')) initNotesWidget();
            if (settings.widgets.includes('quote')) initQuoteWidget();
            if (settings.widgets.includes('trends')) initTrendsWidget();
            lucide.createIcons();
        }

        // Native Widget Functions... (omitted for brevity, they are the same)
        const updateTime=()=>{const e=document.getElementById("clock");e&&(e.textContent=(new Date).toLocaleTimeString("tr-TR",{hour:"2-digit",minute:"2-digit"}))},updateDayProgress=()=>{const e=document.querySelector('[data-widget-id="day_progress"]');if(!e)return;const t=new Date,n=(t-new Date(t.getFullYear(),t.getMonth(),t.getDate()))/864e5*100,o=e.querySelector("#day-progress");o&&(o.style.width=`${n}%`);const d=e.querySelector("#day-progress-text");d&&(d.textContent=`%${n.toFixed(0)}`)};function initWeatherWidget(){const e=document.getElementById("weather-widget");if(!e)return;const t=e.querySelector("#weather-content"),n=e=>{t.textContent=e},o="895284fb2d2c50a520ea537456963d9c",d=async(i,l)=>{try{const s=await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${i}&lon=${l}&appid=${o}&units=metric&lang=tr`);if(!s.ok)throw new Error("Hava durumu verisi alınamadı");const a=await fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${i}&lon=${l}&appid=${o}&units=metric&lang=tr`),c=await s.json(),r=await a.json();t.innerHTML=`<div class="flex justify-between items-center"><span>${c.name}</span><span class="font-bold text-2xl">${Math.round(c.main.temp)}°C</span></div><div class="text-sm capitalize" style="color:var(--text-muted)">${c.weather[0].description}</div>`,e.onclick=()=>{const e=document.getElementById("weather-modal-content");document.getElementById("weather-modal-title").textContent=`${r.city.name} - 5 Günlük Tahmin`;const t={};r.list.forEach(e=>{const n=e.dt_txt.split(" ")[0];t[n]||(t[n]=[]),t[n].push(e)}),e.innerHTML=Object.keys(t).slice(0,5).map(e=>{const n=t[e][0],o=(new Date(e)).toLocaleDateString("tr-TR",{weekday:"long"});return`\n                                <div class="p-4 themed-hover rounded-lg">\n                                    <p class="font-bold">${o}</p>\n                                    <img src="https://openweathermap.org/img/wn/${n.weather[0].icon}@2x.png" alt="${n.weather[0].description}" class="w-16 h-16 mx-auto">\n                                    <p class="text-lg">${Math.round(n.main.temp)}°C</p>\n                                    <p class="text-sm capitalize" style="color:var(--text-muted)">${n.weather[0].description}</p>\n                                </div>\n                            `}).join(""),weatherDetailsModal.classList.remove("hidden"),lucide.createIcons()}}catch(i){console.error(i),n("Veri alınamadı.")}};navigator.geolocation.getCurrentPosition(e=>{const{latitude:t,longitude:n}=e.coords;d(t,n)},()=>{n("Konum izni gerekli.")})}const renderQuickLinks=()=>{const e=document.querySelector("#quick-links-list");if(!e)return;e.innerHTML="",settings.links.forEach(t=>{e.innerHTML+=`<li><a href="${t.url}" target="_blank" class="flex items-center space-x-2 hover:accent-text transition-colors"><i data-lucide="link" class="w-4 h-4"></i><span>${t.name}</span></a></li>`}),lucide.createIcons()};function initTodoWidget(){const e=document.querySelector('[data-widget-id="todo"]');if(!e)return;const t=e.querySelector("#todo-list"),n=e.querySelector("#todo-input"),o=e.querySelector("#add-todo-btn"),d=e.querySelector("#todo-category-select"),i=e.querySelector("#todo-category-filter");function l(){const e=i.value,n=settings.todos.filter(t=>"all"===e||t.category===e);t.innerHTML=0===n.length?`<li class="text-center" style="color: var(--text-muted);">Bu kategoride görev yok.</li>`:n.map(e=>{const n=settings.todos.findIndex(t=>t.text===e.text&&t.category===e.category);return`<li class="flex items-center justify-between p-2 themed-hover"><span class="${e.done?"line-through text-muted":""} cursor-pointer" data-index="${n}">${e.text}</span><button class="remove-todo p-1" data-index="${n}"><i data-lucide="trash-2" class="w-4 h-4" style="color:var(--text-muted)"></i></button></li>`}).join(""),lucide.createIcons()}const s=()=>{""!==n.value.trim()&&(settings.todos.unshift({text:n.value.trim(),done:!1,category:d.value}),n.value="",saveSettings(),l())};o.onclick=s,n.onkeydown=e=>{e.key==="Enter"&&s()},t.onclick=e=>{const n=e.target.closest("button, span");if(!n)return;const o=n.dataset.index;n.matches(".remove-todo, .remove-todo *")?settings.todos.splice(o,1):n.matches("span")&&(settings.todos[o].done=!settings.todos[o].done),saveSettings(),l()},i.onchange=l,l()}const initNotesWidget=()=>{const e=document.querySelector('[data-widget-id="notes"]');if(!e)return;const t=e.querySelector("#notes-area");t.value=settings.notes;let n;t.oninput=()=>{clearTimeout(n),n=setTimeout(()=>{settings.notes=t.value,saveSettings()},500)}},initQuoteWidget=()=>{const e=document.querySelector('[data-widget-id="quote"]');if(!e)return;const t=[{text:"Hayal edebiliyorsan, yapabilirsin.",author:"Walt Disney"},{text:"Başarının sırrı, başlamaktır.",author:"Mark Twain"},{text:"Bugün yap, yarın 'keşke' deme.",author:"Bilinmiyor"}],n=t[Math.floor(Math.random()*t.length)],o=e.querySelector("#quote-text"),d=e.querySelector("#quote-author");o&&(o.textContent=`“${n.text}”`),d&&(d.textContent=`- ${n.author}`)},initTrendsWidget=()=>{const e=document.querySelector('[data-widget-id="trends"]');if(!e)return;const t=["Yapay Zeka Gelişmeleri","Yeni Akıllı Telefonlar","Yazılım Güncellemeleri","Popüler Diziler","Hisse Senedi Piyasası"],n=e.querySelector("#trends-list");n.innerHTML=t.map(e=>`<li><a href="https://www.google.com/search?q=${encodeURIComponent(e)}" target="_blank" class="flex items-center space-x-2 hover:accent-text transition-colors"><i data-lucide="trending-up" class="w-4 h-4"></i><span>${e}</span></a></li>`).join(""),lucide.createIcons()};

        function updateSettingsPanelValues() {
            document.getElementById('theme-select').value = settings.theme;
            document.getElementById('accent-color-input').value = settings.accentColor;
            document.getElementById('accent-color-display').style.backgroundColor = settings.accentColor;
            document.getElementById('bg-image-url').value = settings.backgroundImage;
            document.getElementById('font-select').value = settings.font;
            document.getElementById('column-count').value = settings.columns;
            document.getElementById('column-count-label').textContent = settings.columns;
            document.getElementById('gap-size').value = settings.gap;
            document.getElementById('gap-size-label').textContent = settings.gap;
            updateAnimationToggleUI();
            renderWidgetToggles();
            renderLinkManager();
            renderCustomWidgetManager();
        }

        function renderWidgetToggles() {
            const listEl = document.getElementById('widget-toggle-list');
            listEl.innerHTML = '';
            Object.entries(ALL_WIDGETS).forEach(([id, {name, isCustom}]) => {
                const isEnabled = settings.widgets.includes(id);
                listEl.innerHTML += `
                    <div class="flex items-center justify-between">
                        <span class="text-sm">${name} ${isCustom ? '<span class="text-xs accent-text">(Özel)</span>': ''}</span>
                        <div class="flex items-center">
                            ${isCustom ? `
                                <button class="p-1 mr-2 themed-hover" data-edit-widget="${id}"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                                <button class="p-1 mr-2 themed-hover" data-delete-widget="${id}"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            ` : ''}
                            <button data-widget-id="${id}" class="widget-toggle relative inline-flex items-center h-6 rounded-full w-11 transition-colors ${isEnabled ? 'accent-bg' : 'bg-gray-600'}"><span class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform" style="transform: ${isEnabled ? 'translateX(22px)' : 'translateX(2px)'}"></span></button>
                        </div>
                    </div>`;
            });
            lucide.createIcons();
        }

        function renderLinkManager() { const listEl = document.getElementById('link-list'); listEl.innerHTML = ''; settings.links.forEach((link, index) => { listEl.innerHTML += `<div class="flex items-center justify-between text-sm p-1.5 themed-hover"><div class="truncate"><span class="font-semibold">${link.name}</span><span class="text-xs ml-2" style="color:var(--text-muted)">${link.url}</span></div><button class="remove-link p-1 flex-shrink-0 ml-2" data-index="${index}"><i data-lucide="x" class="w-4 h-4"></i></button></div>`; }); lucide.createIcons(); }
        const updateAnimationToggleUI = () => { const btn = document.getElementById('animation-toggle'); if(!btn) return; btn.className = `relative inline-flex items-center h-6 rounded-full w-11 transition-colors ${settings.animations ? 'accent-bg' : 'bg-gray-600'}`; btn.innerHTML = `<span class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform" style="transform: ${settings.animations ? 'translateX(22px)' : 'translateX(2px)'}"></span>`; };

        function showAlert(title, text) { const modal = document.getElementById('alert-modal'); modal.querySelector('#alert-title').textContent = title; modal.querySelector('#alert-text').textContent = text; modal.classList.remove('hidden'); const close = () => { modal.classList.add('fade-out'); setTimeout(() => { modal.classList.add('hidden'); modal.classList.remove('fade-out'); }, 300); }; modal.querySelector('#alert-ok').onclick = close; }
        function showConfirmation(title, text, onConfirm) { const modal = document.getElementById('confirmation-modal'); modal.querySelector('#modal-title').textContent = title; modal.querySelector('#modal-text').textContent = text; modal.classList.remove('hidden'); const confirmBtn = modal.querySelector('#modal-confirm'); const cancelBtn = modal.querySelector('#modal-cancel'); const newConfirmBtn = confirmBtn.cloneNode(true); confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn); const close = () => { modal.classList.add('fade-out'); setTimeout(() => { modal.classList.add('hidden'); modal.classList.remove('fade-out'); }, 300); }; newConfirmBtn.onclick = () => { onConfirm(); close(); }; cancelBtn.onclick = close; }

        function setupSettingsListeners() {
            document.getElementById('settings-toggle').addEventListener('click', () => settingsPanel.classList.add('open'));
            document.getElementById('settings-close').addEventListener('click', () => settingsPanel.classList.remove('open'));
            document.getElementById('theme-select').addEventListener('change', (e) => { settings.theme = e.target.value; const preset = THEME_PRESETS[settings.theme]; if (preset) { settings.font = preset.font; settings.accentColor = preset.accent; settings.backgroundImage = preset.bg; } applySettings(); saveSettings(); });

            const accentColorInput = document.getElementById('accent-color-input');
            const accentColorDisplay = document.getElementById('accent-color-display');
            accentColorInput.addEventListener('input', (e) => {
                const newColor = e.target.value;
                settings.accentColor = newColor;
                accentColorDisplay.style.backgroundColor = newColor;
                document.documentElement.style.setProperty('--accent-color', newColor);
                document.documentElement.style.setProperty('--accent-text-color', getContrastingTextColor(newColor));
            });
            accentColorInput.addEventListener('change', (e) => {
                settings.accentColor = e.target.value;
                saveSettings();
            });

            document.getElementById('bg-image-url').addEventListener('change', (e) => { settings.backgroundImage = e.target.value; applySettings(); saveSettings(); });
            document.getElementById('font-select').addEventListener('change', (e) => { settings.font = e.target.value; applySettings(); saveSettings(); });
            document.getElementById('animation-toggle').addEventListener('click', () => { settings.animations = !settings.animations; applySettings(); saveSettings(); });
            document.getElementById('column-count').addEventListener('input', (e) => { settings.columns = e.target.value; applySettings(); });
            document.getElementById('column-count').addEventListener('change', saveSettings);
            document.getElementById('gap-size').addEventListener('input', (e) => { settings.gap = e.target.value; applySettings(); });
            document.getElementById('gap-size').addEventListener('change', saveSettings);
            document.getElementById('widget-toggle-list').addEventListener('click', (e) => {
                const button = e.target.closest('.widget-toggle');
                if (button) {
                    const widgetId = button.dataset.widgetId; const index = settings.widgets.indexOf(widgetId); if(index > -1){ settings.widgets.splice(index, 1); } else { settings.widgets.push(widgetId); } renderWidgets(); updateSettingsPanelValues(); saveSettings();
                }
                const editBtn = e.target.closest('[data-edit-widget]');
                if(editBtn) {
                    const widgetId = editBtn.dataset.editWidget;
                    openCustomWidgetModal(widgetId);
                }
                 const deleteBtn = e.target.closest('[data-delete-widget]');
                if(deleteBtn) {
                    const widgetId = deleteBtn.dataset.deleteWidget;
                    showConfirmation("Widget'ı Sil?", "Bu özel widget kalıcı olarak silinecek.", () => {
                        settings.customWidgets = settings.customWidgets.filter(w => w.id !== widgetId);
                        settings.widgets = settings.widgets.filter(wId => wId !== widgetId);
                        settings.widgetOrder = settings.widgetOrder.filter(wId => wId !== widgetId);
                        saveSettings();
                        applySettings();
                    });
                }
            });
            document.getElementById('add-link-btn').addEventListener('click', () => { const nameInput = document.getElementById('link-name-input'); const urlInput = document.getElementById('link-url-input'); if (nameInput.value && urlInput.value) { settings.links.push({ name: nameInput.value, url: urlInput.value.startsWith('http') ? urlInput.value : `https://${urlInput.value}` }); nameInput.value = ''; urlInput.value = ''; saveSettings(); renderLinkManager(); renderQuickLinks(); } });
            document.getElementById('link-list').addEventListener('click', (e) => { const removeBtn = e.target.closest('.remove-link'); if (removeBtn) { settings.links.splice(removeBtn.dataset.index, 1); saveSettings(); renderLinkManager(); renderQuickLinks(); } });
            document.getElementById('export-settings-btn').addEventListener('click', () => { const dataStr = JSON.stringify(settings); const linkElement = document.createElement('a'); linkElement.setAttribute('href', 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr)); linkElement.setAttribute('download', 'dashboard-settings.json'); linkElement.click(); });
            const importFileInput = document.getElementById('import-file-input');
            document.getElementById('import-settings-btn').addEventListener('click', () => importFileInput.click());
            importFileInput.addEventListener('change', (event) => { const reader = new FileReader(); reader.onload = (e) => { try { const importedSettings = JSON.parse(e.target.result); if(typeof importedSettings === 'object' && importedSettings !== null) { settings = {...DEFAULT_SETTINGS, ...importedSettings}; saveSettings(); applySettings(); } else { throw new Error("Invalid format"); } } catch { showAlert("Hata", "Geçersiz veya bozuk ayar dosyası."); }}; reader.readAsText(event.target.files[0]); });
            document.getElementById('reset-settings-btn').addEventListener('click', () => { showConfirmation('Her Şeyi Sıfırla?', 'Tüm ayarlarınız ve verileriniz kalıcı olarak silinecek.', () => { localStorage.removeItem('dashboardSettingsV7'); settings = JSON.parse(JSON.stringify(DEFAULT_SETTINGS)); applySettings(); }); });

            const tabs = document.getElementById('settings-tabs');
            tabs.addEventListener('click', (e) => { if (e.target.tagName === 'BUTTON') { const targetTab = e.target.dataset.tab; tabs.querySelectorAll('button').forEach(btn => btn.classList.remove('active')); e.target.classList.add('active'); document.querySelectorAll('.tab-content').forEach(content => content.classList.toggle('active', content.id === `tab-${targetTab}`)); } });
            document.getElementById('weather-modal-close').addEventListener('click', () => weatherDetailsModal.classList.add('hidden'));

            document.getElementById('add-custom-widget-btn').addEventListener('click', () => openCustomWidgetModal());
        }

        // Command Palette Logic
        const commands = [
            { id: 'search', name: 'Google\'da Ara', desc: '`g ` ön eki ile arama yapın', action: (q) => { window.open(`https://www.google.com/search?q=${q}`) } },
            { id: 'add_todo', name: 'Görev Ekle', desc: '`/todo ` ön eki ile görev ekleyin', action: (q) => { settings.todos.unshift({text: q, done: false, category: 'personal'}); saveSettings(); applySettings(); } },
            { id: 'change_theme', name: 'Tema Değiştir', desc: '`/tema ` ön eki ile temayı değiştirin', action: (q) => { if (Object.keys(THEME_PRESETS).concat(['dark', 'light', 'black']).includes(q)) { settings.theme = q; saveSettings(); applySettings(); }} },
            { id: 'open_settings', name: 'Ayarları Aç', desc: 'Ayarlar panelini açar', action: () => { settingsPanel.classList.add('open'); }}
        ];
        settings.links.forEach(link => {
            commands.push({ id: `link_${link.name}`, name: `Git: ${link.name}`, desc: `/link ${link.name}`, action: () => { window.open(link.url) }})
        });

        let activeCommandIndex = 0;
        function renderCommands(filteredCommands) {
            commandList.innerHTML = filteredCommands.map((cmd, index) => `
                <li class="command-item ${index === activeCommandIndex ? 'selected' : ''} p-4 flex justify-between items-center cursor-pointer" data-index="${index}">
                    <span>${cmd.name}</span>
                    <span class="command-desc text-sm" style="color:var(--text-muted)">${cmd.desc}</span>
                </li>
            `).join('');
        }
        function toggleCommandPalette(show) {
            commandPalette.classList.toggle('hidden', !show);
            if (show) {
                commandInput.value = '';
                commandInput.focus();
                renderCommands(commands);
            }
        }
        commandInput.addEventListener('input', () => {
            const query = commandInput.value.toLowerCase();
            const filtered = commands.filter(c => c.name.toLowerCase().includes(query) || c.desc.toLowerCase().includes(query));
            renderCommands(filtered);
        });
        commandInput.addEventListener('keydown', (e) => {
            const items = commandList.querySelectorAll('.command-item');
            if (e.key === 'ArrowDown') {
                activeCommandIndex = (activeCommandIndex + 1) % items.length;
                renderCommands(commands.filter(c => c.name.toLowerCase().includes(commandInput.value.toLowerCase())));
            } else if (e.key === 'ArrowUp') {
                activeCommandIndex = (activeCommandIndex - 1 + items.length) % items.length;
                renderCommands(commands.filter(c => c.name.toLowerCase().includes(commandInput.value.toLowerCase())));
            } else if (e.key === 'Enter') {
                const query = commandInput.value;
                let commandExecuted = false;
                if (query.startsWith('g ')) { commands.find(c => c.id === 'search').action(query.substring(2)); commandExecuted = true; }
                else if (query.startsWith('/todo ')) { commands.find(c => c.id === 'add_todo').action(query.substring(6)); commandExecuted = true; }
                else if (query.startsWith('/tema ')) { commands.find(c => c.id === 'change_theme').action(query.substring(6)); commandExecuted = true; }
                else if (query.startsWith('/link ')) {
                    const linkName = query.substring(6);
                    const link = settings.links.find(l => l.name.toLowerCase() === linkName.toLowerCase());
                    if(link) { window.open(link.url); commandExecuted = true;}
                } else {
                    const selectedCommand = commands.filter(c => c.name.toLowerCase().includes(query.toLowerCase()))[activeCommandIndex];
                    if (selectedCommand) { selectedCommand.action(); commandExecuted = true; }
                }
                if(commandExecuted) toggleCommandPalette(false);
            } else if (e.key === 'Escape') {
                toggleCommandPalette(false);
            }
        });
        window.addEventListener('keydown', (e) => {
            if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                e.preventDefault();
                toggleCommandPalette(!commandPalette.classList.contains('hidden'));
            }
        });

        // Custom Widget Logic
        const widgetHtml = document.getElementById('widget-html');
        const widgetCss = document.getElementById('widget-css');
        const widgetJs = document.getElementById('widget-js');
        const widgetPreview = document.getElementById('widget-preview');
        let currentEditingWidgetId = null;

        function openCustomWidgetModal(widgetId = null) {
            currentEditingWidgetId = widgetId;
            if (widgetId) {
                const widgetData = settings.customWidgets.find(w => w.id === widgetId);
                widgetHtml.value = widgetData.html;
                widgetCss.value = widgetData.css;
                widgetJs.value = widgetData.js;
            } else {
                widgetHtml.value = '<h3>Merhaba Dünya!</h3>';
                widgetCss.value = 'h3 { color: red; }';
                widgetJs.value = "console.log('Widget çalıştı!');";
            }
            updateWidgetPreview();
            customWidgetModal.classList.remove('hidden');
        }

        function updateWidgetPreview() {
            const content = `
                <style>${widgetCss.value}</style>
                ${widgetHtml.value}
                <script>${widgetJs.value}<\/script>
            `;
            widgetPreview.srcdoc = content;
        }

        document.getElementById('widget-preview-btn').addEventListener('click', updateWidgetPreview);
        document.getElementById('custom-widget-close').addEventListener('click', () => customWidgetModal.classList.add('hidden'));
        document.getElementById('widget-save-btn').addEventListener('click', () => {
            let widgetName;
            if (currentEditingWidgetId) {
                widgetName = settings.customWidgets.find(w => w.id === currentEditingWidgetId).name;
            } else {
                widgetName = prompt("Widget'ınıza bir isim verin:", "Yeni Widget");
                if (!widgetName) return;
            }

            const widgetData = {
                id: currentEditingWidgetId || `custom_${Date.now()}`,
                name: widgetName,
                html: widgetHtml.value,
                css: widgetCss.value,
                js: widgetJs.value,
            };

            if (currentEditingWidgetId) {
                const index = settings.customWidgets.findIndex(w => w.id === currentEditingWidgetId);
                settings.customWidgets[index] = widgetData;
            } else {
                settings.customWidgets.push(widgetData);
                settings.widgets.push(widgetData.id);
                settings.widgetOrder.push(widgetData.id);
            }

            saveSettings();
            applySettings();
            customWidgetModal.classList.add('hidden');
        });

        function renderCustomWidgetManager() {
            const listEl = document.getElementById('custom-widget-list');
            if(!listEl) return;
            listEl.innerHTML = settings.customWidgets.map(widget => `
                <div class="flex items-center justify-between text-sm p-1.5 themed-hover">
                    <span>${widget.name}</span>
                    <div>
                        <button class="p-1 themed-hover" data-edit-widget="${widget.id}"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                        <button class="p-1 themed-hover" data-delete-widget="${widget.id}"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                </div>
            `).join('');
             listEl.addEventListener('click', (e) => {
                 const editBtn = e.target.closest('[data-edit-widget]');
                if(editBtn) {
                    openCustomWidgetModal(editBtn.dataset.editWidget);
                }
                 const deleteBtn = e.target.closest('[data-delete-widget]');
                if(deleteBtn) {
                    const widgetId = deleteBtn.dataset.deleteWidget;
                     showConfirmation("Widget'ı Sil?", "Bu özel widget kalıcı olarak silinecek.", () => {
                        settings.customWidgets = settings.customWidgets.filter(w => w.id !== widgetId);
                        settings.widgets = settings.widgets.filter(wId => wId !== widgetId);
                        settings.widgetOrder = settings.widgetOrder.filter(wId => wId !== widgetId);
                        saveSettings();
                        applySettings();
                    });
                }
             });
            lucide.createIcons();
        }

        Sortable.create(widgetGrid, { animation: 200, ghostClass: 'sortable-ghost', dragClass: 'sortable-drag', onEnd: () => { settings.widgetOrder = Array.from(widgetGrid.querySelectorAll('[data-widget-id]')).map(child => child.dataset.widgetId); saveSettings(); } });

        setupSettingsListeners();
        document.querySelector('#settings-tabs button').classList.add('active');
        document.querySelector('.tab-content').classList.add('active');
        applySettings();

        window.addEventListener('resize', () => { const columns = window.innerWidth < 768 ? 1 : settings.columns; widgetGrid.style.gridTemplateColumns = `repeat(${columns}, minmax(0, 1fr))`; });

        setInterval(updateTime, 1000);
        setInterval(() => { if (settings.widgets.includes('day_progress')) updateDayProgress(); }, 5000);
        setInterval(() => { if (settings.widgets.includes('weather')) initWeatherWidget(); }, 15 * 60 * 1000);
    });
    </script>
</body>
</html>
